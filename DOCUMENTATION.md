# Документация проекта: Гибридный мессенджер

## Обзор

Этот проект представляет собой полнофункциональный гибридный мессенджер с серверной частью на Python и клиентами на C++/Qt и мобильных платформах. Архитектура позволяет подключать различные типы клиентов (TCP, WebSocket, REST) к одному серверу. Проект включает в себя расширенные функции: голосовые/видео звонки, игровые сервисы, систему задач, календарь, аналитику и многое другое.

## Архитектура

### Серверная часть

**Технологии:**
- Python 3.10+
- aiohttp для HTTP/WebSocket
- asyncio для асинхронности
- asyncpg для PostgreSQL
- redis.asyncio для Redis
- PyJWT для аутентификации
- bcrypt для хеширования паролей
- cryptography для шифрования сообщений
- pyotp для двухфакторной аутентификации
- aiortc для WebRTC
- aiohttp-cors для CORS
- pydantic для валидации данных
- prometheus-client для мониторинга

**Основные компоненты:**
- `main.py` - основной серверный код с TCP и WebSocket серверами
- `advanced_auth.py` - улучшенная аутентификация с 2FA и refresh токенами
- `advanced_encryption.py` - улучшенное шифрование сообщений и файлов
- `advanced_security.py` - улучшенная безопасность сессий и защита от атак
- `chat_manager.py` - управление чатами и сообщениями
- `rate_limiter.py` - улучшенная защита от DDoS
- `performance_optimizations.py` - оптимизации производительности
- `scalability_manager.py` - менеджер масштабирования
- `webrtc/signaling.py` - WebRTC сигнализация
- `games/minigames.py` - игровые сервисы
- `tasks/task_manager.py` - система задач
- `analytics/chat_analytics.py` - аналитика чатов
- `calendar/calendar_integration.py` - интеграция с календарем
- `type_definitions.py` - определения типов и протоколов

### Клиентская часть

**Технологии:**
- C++17
- Qt6 для GUI
- Boost.Asio для сетевых операций
- nlohmann/json для работы с JSON
- QtWebEngine для веб-компонентов
- QtMultimedia для аудио/видео

**Компоненты:**
- `mainwindow.cpp/h` - главное окно приложения
- `messagelistmodel.cpp/h` - модель данных для списка сообщений
- `settings.cpp/h` - управление настройками
- `theme_manager.cpp/h` - система тем и персонализации
- `webrtc_client.cpp/h` - клиентская часть WebRTC
- `mainwindow.ui` - дизайн интерфейса
- `resources.qrc` - ресурсы приложения

### Мобильная часть

**Технологии:**
- Flutter 3.x
- Dart 2.19+
- Firebase для push-уведомлений
- sqflite для локальной базы данных
- shared_preferences для хранения настроек
- web_socket_channel для WebSocket соединений

**Компоненты:**
- `lib/main.dart` - главный файл приложения
- `lib/screens/` - экраны приложения
- `lib/widgets/` - виджеты интерфейса
- `lib/services/` - сервисы приложения
- `lib/models/` - модели данных
- `pubspec.yaml` - зависимости проекта

## Безопасность

### Аутентификация
- JWT-токены с временем жизни 15 минут (access token) и 30 дней (refresh token)
- Хеширование паролей с помощью bcrypt
- Проверка токенов на каждом запросе
- Двухфакторная аутентификация (2FA) с использованием TOTP
- Поддержка backup codes для 2FA
- Device fingerprinting для отслеживания устройств
- Blacklisting токенов при выходе из системы
- Проверка JWT ID (jti) для предотвращения повторного использования

### Шифрование
- Шифрование сообщений при помощи Fernet (AES 128 в CBC режиме с HMAC)
- Сквозное шифрование для приватных сообщений
- Шифрование файлов и медиа-контента
- Поддержка шифрования на уровне базы данных
- Использование ключей RSA для обмена сессионных ключей
- Ротация ключей шифрования
- Поддержка Hardware Security Modules (HSM)

### Безопасность сессий
- Управление сессиями через Redis
- Временные ограничения сессий
- Ограничение количества активных сессий на пользователя
- Отзыв сессий администратором
- Проверка IP-адреса и User-Agent для подозрительной активности
- Блокировка пользователей при подозрительной активности
- Поддержка device fingerprinting

### Защита от атак
- Улучшенный рейт-лимитер с sliding window counter
- Защита от SQL-инъекций через подготовленные выражения
- Защита от XSS через автоматическое экранирование
- Защита от CSRF через токены сессий
- IP reputation system для отслеживания подозрительных адресов
- Поддержка CAPTCHA для защиты от ботов
- Мониторинг подозрительной активности
- Система алертов безопасности
- SSL/TLS для защищенных соединений

### Защита
- Рейт-лимитер для предотвращения DDoS-атак
- Проверка подлинности запросов
- Валидация всех входных данных
- Защита от повторных запросов
- Механизмы аудита безопасности
- Поддержка безопасного управления сессиями

## Функциональность

### Основные возможности
- **Чаты**: приватные, групповые, каналы
- **Сообщения**: текстовые, медиа, файлы, реакции, редактирование
- **Голосовые/видео звонки**: через WebRTC с поддержкой аудио/видео/экранного вещания
- **Игры**: встроенные мини-игры (викторины, крестики-нолики, виселица и др.)
- **Задачи**: создание, назначение, отслеживание прогресса
- **Календарь**: события, напоминания, интеграция с чатами
- **Уведомления**: push, email, SMS, in-app
- **Файлы**: загрузка, хранение, шифрование
- **Темы**: темная/светлая тема, пользовательские цветовые схемы
- **Поиск**: полнотекстовый поиск по сообщениям и файлам
- **Аналитика**: статистика чатов, активности пользователей, вовлеченности

### Расширенные возможности
- **Двухфакторная аутентификация**: TOTP с поддержкой QR-кодов и backup codes
- **Сквозное шифрование**: для приватных сообщений и файлов
- **Управление сессиями**: активные сессии, отзыв, ограничения
- **Рейт-лимитинг**: защита от DDoS-атак и спама
- **Модерация контента**: автоматическая и ручная модерация
- **Кастомные интеграции**: поддержка внешних сервисов через API
- **Многопользовательские игры**: с поддержкой рейтингов и статистики
- **Канбан-доски**: для управления задачами
- **Календарь с напоминаниями**: с интеграцией в чаты
- **Система обратной связи**: рейтинги, комментарии, отзывы
- **Персонализация UX**: настройка интерфейса под пользователя
- **Мониторинг производительности**: через Prometheus и Grafana

## Инфраструктура

### Docker и контейнеризация
- **Микросервисная архитектура**: каждый компонент в отдельном контейнере
- **Docker Compose**: для оркестрации всех сервисов
- **Nginx**: для балансировки нагрузки и SSL-терминации
- **Traefik**: альтернативный балансировщик нагрузки
- **PostgreSQL**: для хранения данных
- **Redis**: для кэширования и сессий
- **Prometheus**: для мониторинга метрик
- **Grafana**: для визуализации метрик

### Масштабирование
- **Горизонтальное масштабирование**: возможность запуска нескольких экземпляров сервисов
- **Шардинг базы данных**: разделение таблиц на шарды
- **Партицирование**: разделение больших таблиц на части
- **Многоуровневое кэширование**: L1 (in-memory), L2 (Redis), L3 (Memcached), L4 (CDN)
- **Балансировка нагрузки**: через Nginx/Traefik
- **Кластеризация Redis**: для масштабирования кэширования

## Интеграции

### Внешние сервисы
- **Email**: через SMTP (Gmail, SendGrid, Mailgun)
- **SMS**: через Twilio или AWS SNS
- **Push-уведомления**: через Firebase Cloud Messaging (FCM) или Apple Push Notification Service (APNs)
- **Календарь**: интеграция с Google Calendar, Outlook
- **Файлы**: хранение в AWS S3, Google Cloud Storage
- **Аутентификация**: OAuth 2.0, OpenID Connect
- **Мониторинг**: Prometheus, Grafana, ELK (Elasticsearch, Logstash, Kibana)

### API
- **REST API**: для интеграции с внешними системами
- **WebSocket API**: для реального времени
- **TCP API**: для нативных клиентов
- **gRPC API**: для высокопроизводительных микросервисов
- **GraphQL API**: для гибких запросов данных

## Тестирование

### Unit-тесты
- **pytest**: для модульного тестирования
- **pytest-asyncio**: для асинхронных тестов
- **coverage**: для измерения покрытия кода тестами
- **mock**: для имитации внешних зависимостей

### Интеграционные тесты
- **Тестирование API**: endpoints, запросы, ответы
- **Тестирование базы данных**: запросы, транзакции, индексы
- **Тестирование Redis**: кэширование, pub/sub
- **Тестирование безопасности**: аутентификация, авторизация, шифрование

### Тесты производительности
- **Нагрузочное тестирование**: с использованием aiohttp и других инструментов
- **Тестирование масштабируемости**: с несколькими экземплярами сервисов
- **Тестирование безопасности**: с использованием bandit и других инструментов

## Качество кода

### Инструменты
- **Black**: для форматирования кода
- **isort**: для сортировки импортов
- **Flake8**: для проверки стиля кода
- **mypy**: для проверки типов
- **Bandit**: для проверки безопасности
- **pre-commit**: для автоматического запуска линтеров перед коммитом

### Практики
- **Типизация**: через Pydantic и typing
- **Документация**: через docstrings и Sphinx
- **Тестирование**: через pytest и coverage
- **CI/CD**: через GitHub Actions или GitLab CI
- **Код-ревью**: через автоматические инструменты и ручные проверки

## Запуск и развертывание

### Локальный запуск
1. Клонирование репозитория
2. Настройка .env файла
3. Запуск через docker-compose
4. Проверка работы через тесты

### Продакшен развертывание
1. Настройка SSL-сертификатов
2. Настройка внешних сервисов (email, SMS, push)
3. Настройка мониторинга и логирования
4. Настройка балансировщиков нагрузки
5. Настройка репликации базы данных
6. Настройка кластеризации Redis

## Микросервисы

### Сервис аутентификации
- Управление пользователями
- Двухфакторная аутентификация
- JWT-токены
- Управление сессиями

### Сервис чатов
- Управление чатами и сообщениями
- История сообщений
- Реальное время
- Шифрование

### Сервис уведомлений
- Push-уведомления
- Email-уведомления
- SMS-уведомления
- In-app уведомления

### Сервис задач
- Создание и управление задачами
- Назначение задач
- Отслеживание прогресса
- Интеграция с чатами

### Сервис календаря
- Создание событий
- Напоминания
- Интеграция с чатами
- Приглашения участников

### Сервис игр
- Встроенные мини-игры
- Рейтинги и статистика
- Многопользовательские игры
- Система достижений

### Сервис файлов
- Загрузка и хранение файлов
- Шифрование файлов
- Конвертация медиа-файлов
- Управление доступом к файлам

### Сервис аналитики
- Статистика чатов
- Активность пользователей
- Вовлеченность
- Отчеты и визуализация

## Архитектурные улучшения

### Многоуровневое кэширование
- L1: In-memory кэш (Python dict)
- L2: Redis кэш (быстрый доступ)
- L3: Memcached (для больших объектов)
- L4: CDN (для статических файлов)

### Оптимизация производительности
- Кэширование запросов
- Индексация базы данных
- Оптимизация SQL-запросов
- Асинхронная обработка
- Пул соединений
- Сжатие данных
- Батчинг операций
- Предзагрузка данных

### Безопасность
- Защита от DDoS-атак
- Защита от SQL-инъекций
- Защита от XSS и CSRF
- Шифрование данных
- Аутентификация и авторизация
- Аудит безопасности
- Мониторинг подозрительной активности

## Мониторинг и логирование

### Метрики
- Количество активных пользователей
- Количество сообщений в секунду
- Задержки запросов
- Использование памяти и CPU
- Статусы сервисов

### Логирование
- Структурированные логи (JSON)
- Уровни логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- Логирование безопасности
- Логирование ошибок
- Логирование производительности

### Алерты
- При высокой нагрузке
- При ошибках в сервисах
- При подозрительной активности
- При снижении производительности
- Валидация всех входных данных
- Санитизация пользовательского ввода

## Функциональность

### Основные возможности
- Поддержка TCP и WebSocket соединений
- Приватные и групповые чаты
- Передача файлов
- История сообщений с пагинацией
- Упоминания пользователей
- Уведомления

### Клиентские возможности
- Графический интерфейс на Qt
- Поддержка форматирования текста
- Эмодзи-панель
- Системные уведомления
- Настройки подключения
- Темы оформления

## Инфраструктура

### Docker
- Контейнеризация всех компонентов
- Docker Compose для оркестрации
- Автоматическая сборка образов

### Мониторинг
- Prometheus для сбора метрик
- Grafana для визуализации
- Встроенные логи в каждом сервисе

### CI/CD
- GitHub Actions для автоматизации
- Тестирование на каждом коммите
- Автоматический деплой в production

## Конфигурация

### Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| JWT_SECRET | Секретный ключ для JWT | your-super-secret-jwt-key-change-it |
| MESSAGE_ENCRYPTION_KEY | Ключ для шифрования сообщений | your-message-encryption-key |
| POSTGRES_PASSWORD | Пароль для PostgreSQL | your-secure-password |
| REDIS_PASSWORD | Пароль для Redis | your-secure-redis-password |
| GRAFANA_PASSWORD | Пароль для Grafana | admin |
| DOMAIN | Домен для Traefik | localhost |
| TCP_PORT | Порт для TCP соединений | 8888 |
| HTTP_PORT | Порт для HTTP/WS соединений | 8080 |

## API

### WebSocket API

#### Подключение
```
ws://localhost:8080/ws
```

#### Типы сообщений

**Аутентификация:**
```json
{
  "type": "auth",
  "username": "user123",
  "password": "password123"
}
```

**Ответ при успешной аутентификации:**
```json
{
  "type": "auth_success",
  "token": "jwt-token",
  "user_id": 123,
  "username": "user123",
  "expires_in": 1800
}
```

**Отправка сообщения:**
```json
{
  "type": "message",
  "token": "jwt-token",
  "text": "Привет, мир!"
}
```

**Получение сообщения:**
```json
{
  "type": "new_message",
  "user": "user123",
  "text": "Привет, мир!",
  "timestamp": "2023-12-01T10:00:00Z"
}
```

### REST API

#### Регистрация
```
POST /api/register
Content-Type: application/json

{
  "username": "newuser",
  "password": "password123"
}
```

#### Вход
```
POST /api/login
Content-Type: application/json

{
  "username": "user123",
  "password": "password123"
}
```

#### Отправка сообщения
```
POST /api/send
Content-Type: application/json

{
  "token": "jwt-token",
  "content": "Привет, мир!"
}
```

#### Получение истории
```
GET /api/history?limit=50
Authorization: Bearer jwt-token
```

## База данных

### Структура таблиц

#### users
- id: SERIAL PRIMARY KEY
- username: VARCHAR(50) UNIQUE NOT NULL
- password_hash: VARCHAR(255)
- created_at: TIMESTAMP DEFAULT NOW()
- avatar: VARCHAR(255) DEFAULT ''

#### chats
- id: VARCHAR(100) PRIMARY KEY
- type: VARCHAR(20) NOT NULL (private/group)
- name: VARCHAR(100)
- creator_id: INTEGER REFERENCES users(id)
- participants: INTEGER[]
- created_at: TIMESTAMP DEFAULT NOW()
- last_message: TEXT
- last_activity: TIMESTAMP DEFAULT NOW()
- unread_count: INTEGER DEFAULT 0

#### messages
- id: SERIAL PRIMARY KEY
- chat_id: VARCHAR(100) REFERENCES chats(id)
- sender_id: INTEGER REFERENCES users(id)
- content: TEXT NOT NULL (зашифрованное)
- message_type: VARCHAR(20) DEFAULT 'text'
- timestamp: TIMESTAMP DEFAULT NOW()

#### files
- id: SERIAL PRIMARY KEY
- filename: VARCHAR(255) NOT NULL
- stored_name: VARCHAR(255) NOT NULL
- uploader_id: INTEGER REFERENCES users(id)
- size: BIGINT
- mime_type: VARCHAR(100)
- uploaded_at: TIMESTAMP DEFAULT NOW()

## Масштабирование

### Горизонтальное масштабирование
- Использование Redis для синхронизации сессий
- Поддержка нескольких экземпляров сервера
- Балансировка нагрузки через Nginx

### Вертикальное масштабирование
- Оптимизация SQL-запросов
- Кэширование часто запрашиваемых данных
- Асинхронная обработка запросов

## Мониторинг и логирование

### Метрики
- Количество активных соединений
- Количество сообщений в секунду
- Время отклика API
- Использование памяти и CPU

### Логирование
- Уровни логов: DEBUG, INFO, WARNING, ERROR
- Структурированные логи в JSON-формате
- Ротация логов

## Тестирование

### Unit-тесты
- Тестирование бизнес-логики
- Тестирование безопасности
- Тестирование валидации

### Интеграционные тесты
- Тестирование API
- Тестирование базы данных
- Тестирование сетевых соединений

## Развертывание

### Локальное развертывание
1. Установить Docker и Docker Compose
2. Скопировать .env.example в .env
3. Настроить переменные окружения
4. Запустить `docker-compose up -d`

### Облачное развертывание
1. Настроить DNS-записи
2. Настроить SSL-сертификаты
3. Обновить .env с production-значениями
4. Запустить на сервере

## Лицензия

Проект распространяется под MIT-лицензией.