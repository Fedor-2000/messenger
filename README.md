# Гибридный мессенджер

Этот проект представляет собой полнофункциональный гибридный мессенджер с серверной частью на Python и клиентами на C++/Qt и мобильных платформах.

## Архитектура

- **Сервер**: Python (aiohttp, asyncio, asyncpg, redis) с поддержкой TCP и WebSocket
- **C++/Qt клиент**: Использует Boost.Asio и Qt для подключения к серверу
- **Мобильный клиент**: Flutter для кроссплатформенной поддержки
- **База данных**: PostgreSQL для хранения сообщений, пользователей, задач и событий календаря
- **Кэширование**: Redis для сессий, онлайн-статусов и временных данных
- **Инфраструктура**: Docker, Docker Compose, Nginx, Traefik, Prometheus, Grafana

## Требования

- Docker
- Docker Compose
- Git
- Python 3.10+
- Flutter SDK (для мобильного клиента)
- Android SDK (для сборки APK)

## Установка и запуск

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/messenger-project.git
cd messenger-project
```

2. Скопируйте файл конфигурации:
```bash
cp .env.example .env
```

3. Отредактируйте `.env` файл, установив свои значения:
```bash
JWT_SECRET=your-super-secret-jwt-key-change-it
MESSAGE_ENCRYPTION_KEY=your-message-encryption-key
POSTGRES_PASSWORD=your-secure-password
REDIS_PASSWORD=your-secure-redis-password
GRAFANA_PASSWORD=your-secure-grafana-password
DOMAIN=your-domain.com
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
TWILIO_ACCOUNT_SID=your-twilio-account-sid
TWILIO_AUTH_TOKEN=your-twilio-auth-token
TWILIO_PHONE_NUMBER=+1234567890
```

4. Запустите проект:
```bash
docker-compose up -d
```

Сервер будет доступен:
- TCP (для C++ клиентов): localhost:8888
- WebSocket/HTTP (для веб/мобильных клиентов): localhost:8080
- Веб-интерфейс: http://localhost
- Grafana (мониторинг): http://localhost:3000
- Prometheus: http://localhost:9090

## Структура проекта

```
messenger-project/
├── server/                 # Серверная часть на Python
│   ├── app/               # Основной код сервера
│   │   ├── webrtc/        # WebRTC сигнализация
│   │   ├── games/         # Игровые сервисы
│   │   ├── tasks/         # Система задач
│   │   ├── analytics/     # Аналитика чатов
│   │   ├── calendar/      # Интеграция с календарем
│   │   ├── advanced_auth.py  # Улучшенная аутентификация
│   │   ├── advanced_encryption.py  # Улучшенное шифрование
│   │   ├── advanced_security.py  # Улучшенная безопасность
│   │   ├── performance_optimizations.py  # Оптимизации производительности
│   │   ├── scalability_manager.py  # Менеджер масштабирования
│   │   ├── type_definitions.py  # Определения типов
│   │   └── main.py        # Главный серверный файл
│   ├── tests/             # Тесты
│   │   ├── unit/          # Модульные тесты
│   │   └── integration/   # Интеграционные тесты
│   ├── db-init/           # Скрипты инициализации БД
│   ├── Dockerfile         # Dockerfile для сервера
│   └── requirements.txt   # Зависимости Python
├── client-qt/             # Qt-клиент на C++
├── mobile_client/         # Мобильный клиент на Flutter
├── services/              # Микросервисы
│   ├── auth_service/      # Сервис аутентификации
│   ├── chat_service/      # Сервис чатов
│   ├── notification_service/  # Сервис уведомлений
│   ├── task_service/      # Сервис задач
│   ├── calendar_service/  # Сервис календаря
│   ├── game_service/      # Сервис игр
│   ├── call_service/      # Сервис звонков
│   ├── file_service/      # Сервис файлов
│   ├── analytics_service/ # Сервис аналитики
│   └── ...                # Другие сервисы
├── caching/               # Система кэширования
├── nginx/                 # Конфигурация Nginx
├── traefik/               # Конфигурация Traefik
├── prometheus/            # Конфигурация Prometheus
├── grafana/               # Конфигурация Grafana
├── scripts/               # Скрипты для запуска и обслуживания
├── docker-compose.yml     # Основная конфигурация Docker Compose
├── .env                   # Файл конфигурации
├── .env.example          # Пример файла конфигурации
├── RUNNING_INSTRUCTIONS.md # Инструкция по запуску
├── DOCUMENTATION.md       # Полная документация
├── DOCUMENTATION_FULL.md  # Расширенная документация
├── CODE_QUALITY_GUIDELINES.md # Руководство по качеству кода
├── SECURITY.md            # Документация по безопасности
├── ENHANCED_DOCUMENTATION.md # Улучшенная документация
├── MICROSERVICE_ARCHITECTURE_PLAN.md # План архитектуры микросервисов
└── README.md             # Основная документация
```

## Безопасность

- Все соединения защищены через JWT-аутентификацию с поддержкой refresh токенов
- Двухфакторная аутентификация (2FA) с использованием TOTP
- Сообщения шифруются при передаче и хранении с использованием AES-256-GCM
- Реализована защита от DDoS-атак через улучшенный рейт-лимитер
- Валидация всех входных данных
- Поддержка сквозного шифрования для приватных сообщений
- Механизмы отслеживания подозрительной активности
- Подробное логирование безопасности
- Поддержка безопасного управления сессиями
- Проверка подлинности устройств через device fingerprinting
- Защита от повторного использования токенов через JWT ID (jti)

## Масштабирование

- Архитектура позволяет легко масштабировать количество серверов
- Использование Redis для хранения сессий позволяет использовать несколько экземпляров сервера
- База данных может быть настроена в режиме репликации
- Поддержка шардинга и партицирования таблиц
- Многоуровневое кэширование (L1-L4)
- Автоматическое масштабирование на основе метрик

## Тестирование

- Unit-тесты для бизнес-логики
- Интеграционные тесты для API
- Автоматические тесты в CI/CD pipeline
- Тесты производительности
- Тесты безопасности

## Особенности

- Поддержка одновременной работы TCP и WebSocket клиентов
- Хранение истории сообщений с пагинацией
- Возможность подключения через REST API
- Гибкая система конфигурации через env-переменные
- Полноценный мониторинг с Prometheus и Grafana
- Кроссплатформенные клиенты (десктоп и мобильные)
- Автоматизированные тесты и CI/CD
- Возможность сборки мобильного клиента в APK файл
- Современные инструменты анализа кода и форматирования
- Поддержка уведомлений через email, SMS и push
- Интеграция с внешними сервисами (Twilio, AWS SNS, SMTP)
- Система аналитики и мониторинга производительности
- Поддержка темной/светлой темы и пользовательских тем
- Система задач с интеграцией в чаты
- Календарь с напоминаниями и интеграцией с чатами
- Игровые сервисы с поддержкой многопользовательских игр
- Голосовые/видео звонки через WebRTC
- Система файлов с поддержкой медиа-файлов
- Поддержка опросов и голосований
- Система обратной связи и рейтингов
- Поддержка персонализации и настройки UX
- Интеграция с системами аналитики и мониторинга

## Расширенные возможности

### Голосовые/видео звонки
- Интеграция WebRTC для голосовых и видео звонков
- Сигнализация через WebSocket
- Поддержка аудио и видео потоков
- Управление участниками звонка
- Поддержка экранного вещания
- Запись звонков (опционально)

### Игровые функции
- Встроенные мини-игры (викторины, крестики-нолики, виселица, поиск слов)
- Система игровых сессий
- Рейтинги и статистика игроков
- Многопользовательские игры
- Поддержка турниров и соревнований
- Система достижений и наград

### Система задач
- Создание и управление задачами
- Назначение задач участникам
- Отслеживание прогресса
- Интеграция с чатами
- Поддержка проектов и подзадач
- Канбан-доски и тайм-трекинг
- Уведомления о задачах

### Аналитика чатов
- Статистика активности пользователей
- Анализ вовлеченности
- Визуализация данных
- Отчеты по чатам
- Анализ настроения сообщений
- Обнаружение трендов и популярных тем

### Персонализированные темы
- Поддержка темной и светлой тем
- Настраиваемые цветовые схемы
- Темы для праздников
- Возможность создания пользовательских тем
- Поддержка тем для отдельных чатов

### Интеграция с календарем
- Создание событий и встреч
- Приглашения участников
- Напоминания о событиях
- Синхронизация с внешними календарями
- Поддержка повторяющихся событий
- Интеграция с чатами для обсуждения событий

### Система уведомлений
- Push-уведомления через FCM/APNs
- Email-уведомления через SMTP
- SMS-уведомления через Twilio/AWS SNS
- Веб-уведомления
- Умная фильтрация и приоритезация
- Поддержка расписания уведомлений

### Безопасность и шифрование
- Сквозное шифрование сообщений
- Шифрование файлов и медиа-контента
- Защита от атак (SQL-инъекции, XSS, CSRF)
- Рейт-лимитинг и защита от DDoS
- Аудит безопасности
- Мониторинг подозрительной активности

## Сборка мобильного клиента

Для сборки мобильного клиента в APK файл:

1. Установите Android SDK и Flutter
2. Перейдите в директорию `mobile_client/`
3. Выполните команду:
   ```bash
   flutter build apk --release
   ```
4. APK файл будет создан в `build/app/outputs/flutter-apk/`

Подробные инструкции по установке и сборке см. в файле `mobile_client/BUILD_ANDROID.md`.

## Качество кода

Проект использует современные инструменты для обеспечения качества кода:

- **Black** - для форматирования кода
- **isort** - для сортировки импортов
- **Flake8** - для проверки стиля кода
- **mypy** - для проверки типов
- **Bandit** - для проверки безопасности
- **pre-commit** - для автоматического запуска линтеров перед коммитом
- **pytest** - для модульного и интеграционного тестирования
- **coverage** - для измерения покрытия кода тестами

Для запуска всех проверок качества кода выполните:
```bash
./scripts/run_code_quality.sh
```

Или установите pre-commit хуки:
```bash
pip install pre-commit
pre-commit install
```

## Запуск тестов

Для запуска всех тестов:
```bash
cd server
python -m pytest tests/ -v
```

Для запуска только юнит-тестов:
```bash
python -m pytest tests/unit/ -v
```

Для запуска с измерением покрытия:
```bash
python -m pytest tests/ --cov=app --cov-report=html
```

## Мониторинг и логирование

- Система метрик Prometheus для мониторинга производительности
- Логирование через стандартный модуль logging
- Интеграция с Grafana для визуализации
- Поддержка централизованного логирования через ELK стек
- Алерты при аномалиях производительности
- Мониторинг здоровья сервисов

## Внешние интеграции

- **Email**: SMTP-серверы (Gmail, SendGrid, Mailgun)
- **SMS**: Twilio, AWS SNS
- **Push-уведомления**: Firebase Cloud Messaging (FCM), Apple Push Notification Service (APNs)
- **Календарь**: Google Calendar, Outlook, CalDAV
- **Файлы**: AWS S3, Google Cloud Storage, локальное хранилище
- **Аутентификация**: OAuth 2.0, OpenID Connect
- **Мониторинг**: Prometheus, Grafana, ELK (Elasticsearch, Logstash, Kibana)

## Поддержка и развитие

Проект активно развивается и поддерживается. Для вопросов и предложений:
- Создайте issue в репозитории
- Отправьте pull request
- Обратитесь к документации в соответствующих файлах